<!DOCTYPE html>
<html dir="ltr" class="client-js" lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="UTF-8"><title>Bcache - ArchWiki</title>
<meta name="generator" content="MediaWiki 1.22.11">
<link rel="shortcut icon" href="https://wiki.archlinux.org/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="https://wiki.archlinux.org/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="copyright" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="https://wiki.archlinux.org/index.php?title=Special:RecentChanges&amp;feed=atom">
<link rel="stylesheet" href="Bcache%20-%20ArchWiki_files/load.css">
<!--[if IE 6]><link rel="stylesheet" href="/skins/archlinux/IE60Fixes.css?303" media="screen" /><![endif]-->
<!--[if IE 7]><link rel="stylesheet" href="/skins/archlinux/IE70Fixes.css?303" media="screen" /><![endif]--><style>
.mw-collapsible-toggle{float:right} li .mw-collapsible-toggle{float:none} .mw-collapsible-toggle-li{list-style:none}
/* cache key: archwiki:resourceloader:filter:minify-css:7:4250852ed2349a0d4d0fc6509a3e7d4c */
.suggestions{overflow:hidden;position:absolute;top:0;left:0;width:0;border:none;z-index:1099;padding:0;margin:-1px -1px 0 0} html > body .suggestions{margin:-1px 0 0 0}.suggestions-special{position:relative;background-color:white;cursor:pointer;border:solid 1px #aaaaaa;padding:0;margin:0;margin-top:-2px;display:none;padding:0.25em 0.25em;line-height:1.25em}.suggestions-results{background-color:white;cursor:pointer;border:solid 1px #aaaaaa;padding:0;margin:0}.suggestions-result{color:black;margin:0;line-height:1.5em;padding:0.01em 0.25em;text-align:left}.suggestions-result-current{background-color:#4C59A6;color:white}.suggestions-special .special-label{color:gray;text-align:left}.suggestions-special .special-query{color:black;font-style:italic;text-align:left}.suggestions-special .special-hover{background-color:silver}.suggestions-result-current .special-label,.suggestions-result-current .special-query{color:white}.autoellipsis-matched,.highlight{font-weight:bold}
/* cache key: archwiki:resourceloader:filter:minify-css:7:9780324491b653a3780e2d029bdc140c */
.postedit-container{margin:0 auto;position:fixed;top:0;height:0;left:50%;z-index:1000;font-size:13px}.postedit-container:hover{cursor:pointer}.postedit{position:relative;top:0.6em;left:-50%;padding:.6em 3.6em .6em 1.1em;line-height:1.5625em;color:#626465;background-color:#f4f4f4;border:1px solid #dcd9d9;text-shadow:0 0.0625em 0 rgba(255,255,255,0.5);border-radius:5px;-webkit-box-shadow:0 2px 5px 0 #ccc;box-shadow:0 2px 5px 0 #ccc;-webkit-transition:all 0.25s ease-in-out;-moz-transition:all 0.25s ease-in-out;-ms-transition:all 0.25s ease-in-out;-o-transition:all 0.25s ease-in-out;transition:all 0.25s ease-in-out}.skin-monobook .postedit{top:6em !important}.postedit-faded{opacity:0}.postedit-icon{padding-left:41px;  line-height:25px;background-repeat:no-repeat;background-position:8px 50%}.postedit-icon-checkmark{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAABblBMVEUAAAD///////9PfTf///80aRdTgjn///9Feij///////////9Rfzf///////////9PfjZRgDh1o1xOfTb///////+bwYqLtnj///////9PfTa82K////9WhT6YxIL///9QgDdTgzr////////j7uDl7eLq8efi693k7OH///////9UhjuBr2rp9uRUhjr///9YljVKgir///9WiTlYjT3////9/v57vFlbkT5PjC9dlD/5/fhuq09stUTs9uhxuElctCpfnT1huDFloEZloUZmpENmvDZpvDxpvTxqvjxrvT5rvT9rwTxsqktswD5uwkBvuUdxw0NztFBztU9ztVBzwkp0tlJ1xkd2t1R3uVR4w1F4xk54x014yE15uVZ5v1R5xVB6v1R7yFJ8wVh9xVl9yFR9yVd9ylN+xVh+yFd/x1l/yFeAylmEx1+Ny2uY0Hqe04Wj1Ymv3Ze33qLD47TJ5L3O6cPU7Mrq9eb2+/Q4j37OAAAAQHRSTlMAAQIEBAUFBQwPFB4fJCUoKiosQEhJS01RUlZZXmdydXaChYuSlJSWmJmoq6uur8LExcvM19fg5ejt8fX2+Pr7SljgewAAAKpJREFUGBkFwQNCAwAAAMDLtl3LtrG4rWXbtvX77gAgZ6grFwC0bhwNVgKgdPZx8b0dgLi+s7Wn0VoAqpfOI9+BNADZI7fLrz2pSEwGHZuH+78lSK8ZLkLezF3ooyUG3VPXq2USei9WngeyoG195yBYWDF3E/2pAhl1e9Gr8bGT+bfOFCC2fnvh4X7rcqIAQNNu+HT6sxkAjceTL/2ZAIhv+PorBwBJxfkA//dFHSCBy/UTAAAAAElFTkSuQmCC);background-image:url(/resources/mediawiki.action/images/green-checkmark.png?2013-12-08T09:10:00Z)!ie;background-position:left}.postedit-close{position:absolute;padding:0 .8em;right:0;top:0;font-size:1.25em;font-weight:bold;line-height:2.3em;color:black;text-shadow:0 0.0625em 0 white;text-decoration:none;opacity:0.2;filter:alpha(opacity=20)}.postedit-close:hover{color:black;text-decoration:none;opacity:0.4;filter:alpha(opacity=40)}
/* cache key: archwiki:resourceloader:filter:minify-css:7:344f1a27eec76b02caaf113b58edacec */</style><style>
.suggestions a.mw-searchSuggest-link,.suggestions a.mw-searchSuggest-link:hover,.suggestions a.mw-searchSuggest-link:active,.suggestions a.mw-searchSuggest-link:focus{text-decoration:none;color:black}.suggestions-result-current a.mw-searchSuggest-link,.suggestions-result-current a.mw-searchSuggest-link:hover,.suggestions-result-current a.mw-searchSuggest-link:active,.suggestions-result-current a.mw-searchSuggest-link:focus{color:white}
/* cache key: archwiki:resourceloader:filter:minify-css:7:52b1797f70c7e4094dfa4191101944e8 */</style><meta name="ResourceLoaderDynamicStyles" content="">

<script src="Bcache%20-%20ArchWiki_files/load_004.php"></script><script src="Bcache%20-%20ArchWiki_files/load_003.php"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Bcache","wgTitle":"Bcache","wgCurRevisionId":337808,"wgRevisionId":337808,"wgArticleId":16083,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["File systems"],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"Bcache","wgIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[]});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function(){mw.user.options.set({"ccmeonemails":0,"cols":80,"date":"default","diffonly":0,"disablemail":0,"disablesuggest":0,"editfont":"default","editondblclick":0,"editsection":1,"editsectiononrightclick":0,"enotifminoredits":0,"enotifrevealaddr":0,"enotifusertalkpages":1,"enotifwatchlistpages":0,"extendwatchlist":0,"fancysig":0,"forceeditsummary":0,"gender":"unknown","hideminor":0,"hidepatrolled":0,"imagesize":2,"justify":0,"math":1,"minordefault":0,"newpageshidepatrolled":0,"nocache":0,"noconvertlink":0,"norollbackdiff":0,"numberheadings":0,"previewonfirst":0,"previewontop":1,"rcdays":7,"rclimit":50,"rememberpassword":0,"rows":25,"searchlimit":20,"showhiddencats":0,"shownumberswatching":1,"showtoc":1,"showtoolbar":1,"skin":"archlinux","stubthreshold":0,"thumbsize":2,"underline":2,"uselivepreview":0,"usenewrc":0,"vector-simplesearch":1,"watchcreations":0,"watchdefault":0,"watchdeletion":0,"watchlistdays":3,"watchlisthideanons":0,"watchlisthidebots":
0,"watchlisthideliu":0,"watchlisthideminor":0,"watchlisthideown":0,"watchlisthidepatrolled":0,"watchmoves":0,"wllimit":250,"useeditwarning":1,"prefershttps":1,"language":"en","variant-gan":"gan","variant-iu":"iu","variant-kk":"kk","variant-ku":"ku","variant-shi":"shi","variant-sr":"sr","variant-tg":"tg","variant-uz":"uz","variant-zh":"zh","searchNs0":true,"searchNs1":false,"searchNs2":false,"searchNs3":false,"searchNs4":false,"searchNs5":false,"searchNs6":false,"searchNs7":false,"searchNs8":false,"searchNs9":false,"searchNs10":false,"searchNs11":false,"searchNs12":false,"searchNs13":false,"searchNs14":false,"searchNs15":false,"variant":"en"});},{},{});mw.loader.implement("user.tokens",function(){mw.user.tokens.set({"editToken":"+\\","patrolToken":false,"watchToken":false});},{},{});
/* cache key: archwiki:resourceloader:filter:minify-js:7:85c90aa16eaeef41f8c16fb94950cfbf */
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax"]);
}</script><script src="Bcache%20-%20ArchWiki_files/load.php"></script>
<script src="Bcache%20-%20ArchWiki_files/load_002.php" async=""></script></head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Bcache skin-archlinux action-view">

<div id="archnavbar"><!-- Arch Linux global navigation bar -->
	<div id="archnavbarlogo">
		<p><a id="logo" href="http://www.archlinux.org/"></a></p>
	</div>
	<div id="archnavbarmenu">
		<ul id="archnavbarlist">
			<li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki" class="anb-selected"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li>		</ul>
	</div>
</div><!-- #archnavbar -->

<div id="globalWrapper">
<div id="column-content"><div id="content" class="mw-body-primary" role="main">
	<a id="top"></a>
	
	<h1 id="firstHeading" class="firstHeading" lang="en"><span dir="auto">Bcache</span></h1>
	<div id="bodyContent" class="mw-body">
		<div id="siteSub">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="jump-to-nav" class="mw-jump">Jump to: <a href="#column-one">navigation</a>, <a href="#searchInput">search</a></div>

		<!-- start content -->
<div id="mw-content-text" dir="ltr" class="mw-content-ltr" lang="en"><div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2><span class="toctoggle">&nbsp;[<a href="#" class="internal" id="togglelink">hide</a>]&nbsp;</span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Introduction"><span class="tocnumber">1</span> <span class="toctext">Introduction</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Setting_up_a_bcache_device_on_an_existing_system"><span class="tocnumber">2</span> <span class="toctext">Setting up a bcache device on an existing system</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Installation_to_a_bcache_device"><span class="tocnumber">3</span> <span class="toctext">Installation to a bcache device</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="#Configuring"><span class="tocnumber">4</span> <span class="toctext">Configuring</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="#Advanced_operations"><span class="tocnumber">5</span> <span class="toctext">Advanced operations</span></a>
<ul>
<li class="toclevel-2 tocsection-6"><a href="#Resize_backing_device"><span class="tocnumber">5.1</span> <span class="toctext">Resize backing device</span></a>
<ul>
<li class="toclevel-3 tocsection-7"><a href="#Example_of_growing"><span class="tocnumber">5.1.1</span> <span class="toctext">Example of growing</span></a></li>
<li class="toclevel-3 tocsection-8"><a href="#Example_of_shrinking"><span class="tocnumber">5.1.2</span> <span class="toctext">Example of shrinking</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-9"><a href="#Troubleshooting"><span class="tocnumber">6</span> <span class="toctext">Troubleshooting</span></a>
<ul>
<li class="toclevel-2 tocsection-10"><a href="#.2Fdev.2Fbcache_device_doesn.27t_exist_on_bootup"><span class="tocnumber">6.1</span> <span class="toctext">/dev/bcache device doesn't exist on bootup</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="#.2Fsys.2Ffs.2Fbcache.2F_doesn.27t_exist"><span class="tocnumber">6.2</span> <span class="toctext">/sys/fs/bcache/ doesn't exist</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="Introduction">Introduction</span></h2>
<p>Bcache allows one to use an SSD as a read/write cache (in writeback 
mode) or read cache (writethrough or writearound) for another 
blockdevice (generally a rotating HDD or array). This article will show 
how to install arch using Bcache as the root partition. For an intro to 
bcache itself, see <a rel="nofollow" class="external text" href="http://bcache.evilpiepirate.org/">the bcache homepage</a>. Be sure to read and reference <a rel="nofollow" class="external text" href="http://atlas.evilpiepirate.org/git/linux-bcache.git/tree/Documentation/bcache.txt?h=bcache">the bcache manual</a>. Bcache is in the mainline kernel since 3.10. The kernel on the arch install disk includes the bcache module since 2013.08.01.
</p><p>An alternative to Bcache is Facebook's <a href="https://wiki.archlinux.org/index.php/Flashcache" title="Flashcache">Flashcache</a> and its offspring <a href="https://wiki.archlinux.org/index.php/Enhanceio" title="Enhanceio" class="mw-redirect">Enhanceio</a>.
</p><p>Bcache needs the backing device to be formatted as a bcache block device.  In most cases, <a rel="nofollow" class="external text" href="https://github.com/g2p/blocks">blocks to-bcache</a> can do an in-place conversion.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;"><strong> Warning: </strong>Be sure you back up any important data first.</div>
<h2><span class="mw-headline" id="Setting_up_a_bcache_device_on_an_existing_system">Setting up a bcache device on an existing system</span></h2>
<p>1. Install the <span style="font-family: monospace"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/bcache-tools/">bcache-tools</a></span> package from <a href="https://wiki.archlinux.org/index.php/AUR" title="AUR" class="mw-redirect">AUR</a>.
</p><p>2. Create a backing device (This will typically be your 
mechanical drive). The backing device can be a whole device, a partition
 or any other standard block device. This will create /dev/bcache0
</p>
<pre>   # make-bcache -B /dev/sdx1
</pre>
<p>3. Create a cache device (This will typically be your SSD). The cache
 device can be a whole device, a partition or any other standard block 
device
</p>
<pre>   # make-bcache -C /dev/sdx1
</pre>
<p>4. Register the cache device against your backing device. We need to 
find the UUID of your cache device and then add it to the bcache device 
initially. Udev rules will take care of this on reboot and will only 
need to be done once.
</p>
<pre>   # cd /sys/fs/bcache
   # ls
   # echo "UUID" &gt; /sys/block/bcache0/bcache/attach
</pre>
<p>5. Change your cache mode (if you want to cache writes as well as reads):
</p>
<pre>   # echo writeback &gt; /sys/block/bcache0/bcache/cache_mode
</pre>
<p>6. If you want to have this partition available during the initcpio 
(i.e. you require it at some point in the boot process) you need to add 
'bcache' to your modules array in /etc/mkinitcpio.conf as well as adding
 the 'bcache' hook in your list between block and filesystem.
</p><p><br>
</p>
<h2><span class="mw-headline" id="Installation_to_a_bcache_device">Installation to a bcache device</span></h2>
<p>1. Boot on the install disk (2013.08.01 minimum).
</p><p>2. Install the <span style="font-family: monospace"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/bcache-tools/">bcache-tools</a></span> package from <a href="https://wiki.archlinux.org/index.php/AUR" title="AUR" class="mw-redirect">AUR</a>.
</p><p>3. Partition your hdd
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;"><strong> Note: </strong>While
 it may be true that Grub2 does not offer support for bcache as noted 
below, it does, however, fully support UEFI. It follows then, that so 
long as the necessary modules for the linux kernel to properly handle 
your boot device are either compiled into the kernel or are included in 
an initramfs, and you can include these files on it, the separate boot 
partition described below may be omitted in favor of the FAT EFI system 
partition. See <a href="https://wiki.archlinux.org/index.php/GRUB" title="GRUB">GRUB</a> and/or <a href="https://wiki.archlinux.org/index.php/UEFI" title="UEFI" class="mw-redirect">UEFI</a> for more.</div>
<p>grub can't handle bcache, so you'll need at least 2 partitions (boot 
and one for the bcache backing device). If you're doing UEFI, you'll 
need an EFI System Partition (ESP) as well. E.g.:
</p>
<pre>     1            2048           22527   10.0 MiB    EF00  EFI System
     2           22528          432127   200.0 MiB   8300  arch_boot
     3          432128       625142414   297.9 GiB   8300  bcache_backing
</pre>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;"><strong> Note: </strong>This
 example has no swapfile/partition. For a swap partition on the cache, 
use LVM in step 7. For a swap partition outside the cache, be sure to 
make a swap partition now.</div>
<p>4. Configure your HDD as a bcache backing device.
</p>
<pre># make-bcache -B /dev/sda3
</pre>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;"><strong> Note: </strong>
<ul>
<li> When preparing any boot disk it is important to know the 
ramifications of any decision you may make. Please review and review 
again the documentation for your chosen boot-loader/-manager and 
consider seriously how it might relate to bcache.
</li>
<li> If all associated disks are partitioned at once as below bcache 
will automatically attach "-B backing stores" to the "-C ssd cache" and 
step 6 is unnecessary.
</li>
</ul>
</div>
<pre># make-bcache -B /dev/sd? /dev/sd? -C /dev/sd?
</pre>
<p>5. Register any bcache devices with the kernel (this needs to done 
every bootup if you do not use the bcache hook in your mkinitcpio, 
unless you attach the bcache devices after boot has completed)
</p>
<pre># for i in /dev/sd*; do echo $i; echo $i &gt; /sys/fs/bcache/register_quiet; done
</pre>
<p>You now have a <code style="display:inline-block; padding: 0.1em 0.3em;">/dev/bcache0</code> device.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;"><strong> Note: </strong>the bcache user manual says to do <code style="display:inline-block; padding: 0.1em 0.3em;">echo /dev/sd* &gt; /sys/fs/bcache/register_quiet</code>, but this did not work for me.</div>
<p>6. Configure your SSD
</p><p>Format the SSD as a caching device and link it to the backing device
</p>
<pre># make-bcache -C /dev/sdb
# echo /dev/sdb &gt; /sys/fs/bcache/register 
# echo <i>UUID__from_previous_command</i> &gt; /sys/block/bcache0/bcache/attach
</pre>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;"><strong> Note: </strong>If the UUID is forgotten, it can be found with <code style="display:inline-block; padding: 0.1em 0.3em;">ls /sys/fs/bcache/</code> after the cache device has been registered.</div>
<p>7. Format the bcache device. Use LVM or btrfs subvolumes if you want to divide up the <code style="display:inline-block; padding: 0.1em 0.3em;">/dev/bcache0</code> device how you like (ex for seperate <code style="display:inline-block; padding: 0.1em 0.3em;">/</code>, <code style="display:inline-block; padding: 0.1em 0.3em;">/home</code>, <code style="display:inline-block; padding: 0.1em 0.3em;">/var</code>, etc):
</p>
<pre># mkfs.btrfs /dev/bcache0
# mount /dev/bcache0 /mnt/
# btrfs subvolume create /mnt/root
# btrfs subvolume create /mnt/home
# umount /mnt
</pre>
<p>8. Prepare the installation mount point:
</p>
<pre># mkfs.ext4 /dev/sda2
# mkfs.msdos /dev/sda1 (if your ESP is at least 500MB, use mkfs.vfat to make a FAT32 partition instead)
# pacman -S arch-install-scripts
# mount /dev/bcache0 -o subvol=root,compress=lzo /mnt/
# mkdir /mnt/boot /mnt/home
# mount /dev/bcache0 -o subvol=home,compress=lzo /mnt/home
# mount /dev/sda2 /mnt/boot
# mkdir /boot/efi
# mount /dev/sda1 /mnt/boot/efi/
</pre>
<p>9. Install the system as per the <a href="https://wiki.archlinux.org/index.php/Installation_guide#Connect_to_the_Internet" title="Installation guide">Installation Guide</a> as normal except this:
</p><p>Before you edit <code style="display:inline-block; padding: 0.1em 0.3em;">/etc/mkinitcpio.conf</code> and run <code style="display:inline-block; padding: 0.1em 0.3em;">mkinitcpio -p linux</code>:
</p>
<ul>
<li> install <span style="font-family: monospace"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/bcache-tools/">bcache-tools</a></span> package from the <a href="https://wiki.archlinux.org/index.php/AUR" title="AUR" class="mw-redirect">AUR</a>.
</li>
<li> Edit <code style="display:inline-block; padding: 0.1em 0.3em;">/etc/mkinitcpio.conf</code>:
<ul>
<li> add the "bcache" module
</li>
<li> add the "bcache" hook between block and filesystem hooks
</li>
</ul>
</li>
</ul>
<h2><span class="mw-headline" id="Configuring">Configuring</span></h2>
<p>There are many options that can be configured (such as cache mode, 
cache flush interval, sequential write heuristic, etc.) This is 
currently done by writing to files in <code style="display:inline-block; padding: 0.1em 0.3em;">/sys</code>. See the <a rel="nofollow" class="external text" href="http://atlas.evilpiepirate.org/git/linux-bcache.git/tree/Documentation/bcache.txt">bcache user documentation</a>.
</p><p>Changing the cache mode is done by echoing one of 'writethrough',
 'writeback', 'writearound' or 'none' to 
/sys/block/bcache[0-9]/bcache/cache_mode.
</p>
<h2><span class="mw-headline" id="Advanced_operations">Advanced operations</span></h2>
<h3><span class="mw-headline" id="Resize_backing_device">Resize backing device</span></h3>
<p>It's possible to resize the backing device so long as you don't move the partition start. This process is described on <a rel="nofollow" class="external text" href="http://comments.gmane.org/gmane.linux.kernel.bcache.devel/249">the mailing list</a>. Here is an example using btrfs volume directly on bcache0. For LVM containers or for other filesystems, procedure will differ.
</p>
<h4><span class="mw-headline" id="Example_of_growing">Example of growing</span></h4>
<p>In this example, I grow the filesystem by 4GB. 
</p><p>1. Reboot to a live CD/USB Drive (need not be bcache enabled) and
 use fdisk, gdisk, parted, or your other favorite tool to delete the 
backing partition and recreate it with the same start and a total size 
4G larger. 
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;"><strong> Warning: </strong>Do
 not use a tool like GParted that might perform filesystem operations! 
It will not recognize the bcache partition and might overwrite part of 
it!!</div>
<p>2. Reboot to your normal install. Your filesystem will be currently 
mounted. That is fine. Issue the command to resize the partition to its 
maximum. For btrfs, that is
</p>
<pre># btrfs filesystem resize max /
</pre>
<p>For ext3/4, that is:
</p>
<pre># resize2fs /dev/bcache0
</pre>
<h4><span class="mw-headline" id="Example_of_shrinking">Example of shrinking</span></h4>
<p>In this example, I shrink the filesystem by 4GB.
</p><p>1. Disable writeback cache (switch to writethrough cache) and wait for the disk to flush.
</p>
<pre># echo writethrough &gt; /sys/block/bcache0/bcache/cache_mode
$ watch cat /sys/block/bcache0/bcache/state
</pre>
<p>wait until state reports "clean". This might take a while.
</p><p>2. Shrink the mounted filesystem by something more than the 
desired amount, to ensure we don't accidentally clip it later. For 
btrfs, that is:
</p>
<pre># btrfs filesystem resize -5G /
</pre>
<p>For ext3/4 you can use <i>resize2fs</i>, but only if the partition is unmounted
</p>
<pre>$ df -h /home
/dev/bcache0    290G   20G   270G   1% /home
# umount /home
# resize2fs /dev/bcache0 283G
</pre>
<p>3. Reboot to a LiveCD/USB drive (doesn't need to support bcache) and 
use fdisk, gdisk, parted, or your other favorite tool to delete the 
backing partition and recreate it with the same start and a total size 
4G smaller.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;"><strong> Warning: </strong>Do
 not use a tool like GParted that might perform filesystem operations! 
It won't recognize the bcache partition and might overwrite part of it!!</div>
<p>4. Reboot to your normal install. Your filesystem will be currently 
mounted. That is fine. Issue the command to resize the partition to its 
maximum (that is, the size we shrunk the actual partition to in step 3).
 For btrfs, that is:
</p>
<pre># btrfs filesystem resize max /
</pre>
<p>For ext3/4, that is:
</p>
<pre># resize2fs /dev/bcache0
</pre>
<p>5. Re-enable writeback cache if you want that enabled:
</p>
<pre># echo writeback &gt; /sys/block/bcache0/bcache/cache_mode
</pre>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;"><strong> Note: </strong>If
 you're very careful you can shrink the filesystem to the exact size in 
step 2 and avoid step 4. Be careful, though, many partition tools don't 
do exactly what you want, but instead adjust the requested partition 
start/end points to end on sector boundaries. This may be difficult to 
calculate ahead of time</div>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3><span class="mw-headline" id=".2Fdev.2Fbcache_device_doesn.27t_exist_on_bootup">/dev/bcache device doesn't exist on bootup</span></h3>
<p>If you are sent to a busy box shell with an error:
</p>
<pre>ERROR: Unable to find root device 'UUID=b6b2d82b-f87e-44d5-bbc5-c51dd7aace15'.
You are being dropped to a recovery shell
    Type 'exit' to try and continue booting</pre>
<p>This might happen if the backing device is configured for "writeback"
 mode (default is writearound). When in "writeback" mode, the 
/dev/bcache0 device is not started until the cache device is both 
registered and attached. Registering is something that needs to happen 
every bootup, but attaching should only have to be done once. I've 
sometime had to re-attach.
</p><p>To continue booting, try one of the following:
</p>
<ul>
<li> Register both the backing device and the cacheing device
</li>
</ul>
<pre># echo /dev/sda3 &gt; /sys/fs/bcache/register
# echo /dev/sdb &gt; /sys/fs/bcache/register
</pre>
<p>If the /dev/bcache0 device now exists, type exit and continue 
booting. You will need to fix your initcpio to ensure devices are 
registered before mounting the root device.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;"><strong> Note: </strong>
<ul>
<li> An error of "sh: echo: write error: Invalid argument" means the 
device was already registered or is not recognized as either a bcache 
backing device or cache. If using the udev rule on boot it should only 
attempt to register a device if it finds a bcache superblock
</li>
<li> This can also happen if using udev's 69-bcache.rules in 
Installation's step 7 and blkid and bcache-probe "disagree" due to rogue
 superblocks. See <a rel="nofollow" class="external text" href="http://bcache.evilpiepirate.org/#index6h1">bcache's wiki</a> for a possible explanation/resolution.
</li>
</ul>
</div>
<ul>
<li> Re-attach the cache to the backing device:
</li>
</ul>
<p>If the cache device was registered, a folder with the UUID of the cache should exist in <code style="display:inline-block; padding: 0.1em 0.3em;">/sys/fs/bcache</code>. Use that UUID when following the example below:
</p>
<pre># ls /sys/fs/bcache/
b6b2d82b-f87e-44d5-bbc5-c51dd7aace15     register     register_quiet
# echo b6b2d82b-f87e-44d5-bbc5-c51dd7aace15 &gt; /sys/block/sda/sda3/bcache/attach
</pre>
<p>If the <code style="display:inline-block; padding: 0.1em 0.3em;">/dev/bcache0</code>
 device now exists, type exit and continue booting. You should not have 
to do this again. If it persists, ask on the bcache mailing list.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;"><strong> Note: </strong>An error of <code style="display:inline-block; padding: 0.1em 0.3em;">sh: echo: write error: Invalid argument</code> means the device was already attached. An error of <code style="display:inline-block; padding: 0.1em 0.3em;">sh: echo: write error: No such file or directory</code> means the UUID is not a valid cache (make sure you typed it correctly).</div>
<ul>
<li> Invalidate the cache and force the backing device to run without 
it. You might want to check some stats, such as "dirty_data" so you have
 some idea of how much data will be lost.
</li>
</ul>
<pre># cat /sys/block/sda/sda3/bcache/dirty_data
-3.9M
</pre>
<p>dirty data is data in the cache that has not been written to the 
backing device. If you force the backing device to run, this data will 
be lost, even if you later re-attach the cache.
</p>
<pre># cat /sys/block/sda/sda3/bcache/running
0
# echo 1 &gt; /sys/block/sda/sda3/bcache/running
</pre>
<p>The <code style="display:inline-block; padding: 0.1em 0.3em;">/dev/bcache0</code>
 device will now exist. Type exit and continue booting. You might want 
to unregister the cache device and run make-bcache again. An fsck on <code style="display:inline-block; padding: 0.1em 0.3em;">/dev/bcache0</code> would also be wise. See the <a rel="nofollow" class="external text" href="http://atlas.evilpiepirate.org/git/linux-bcache.git/tree/Documentation/bcache.txt?h=bcache">bcache user documentation</a>.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;"><strong> Warning: </strong>Only invalidate the cache if one of the two options above did not work.</div>
<h3><span class="mw-headline" id=".2Fsys.2Ffs.2Fbcache.2F_doesn.27t_exist">/sys/fs/bcache/ doesn't exist</span></h3>
<p>The kernel you booted is not bcache enabled.
</p>
<!-- 
NewPP limit report
CPU time usage: 0.033 seconds
Real time usage: 0.036 seconds
Preprocessor visited node count: 499/1000000
Preprocessor generated node count: 979/1000000
Postâ€expand include size: 16265/2097152 bytes
Template argument size: 9812/2097152 bytes
Highest expansion depth: 7/40
Expensive parser function count: 0/100
-->

<!-- Saved in parser cache with key archwiki:pcache:idhash:16083-0!*!0!!en!*!* and timestamp 20140928030232
 -->
</div><div class="printfooter">
Retrieved from "<a href="https://wiki.archlinux.org/index.php?title=Bcache&amp;oldid=337808">https://wiki.archlinux.org/index.php?title=Bcache&amp;oldid=337808</a>"</div>
		<div id="catlinks" class="catlinks"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="https://wiki.archlinux.org/index.php/Special:Categories" title="Special:Categories">Category</a>: <ul><li><a href="https://wiki.archlinux.org/index.php/Category:File_systems" title="Category:File systems">File systems</a></li></ul></div></div>		<!-- end content -->
				<div class="visualClear"></div>
	</div>
</div></div>
<div id="column-one">
	<h2>Navigation menu</h2>
	<div id="p-cactions" class="portlet" role="navigation">
		<h3>Views</h3>
		<div class="pBody">
			<ul>
				<li id="ca-nstab-main" class="selected"><a href="https://wiki.archlinux.org/index.php/Bcache" title="View the content page [alt-shift-c]" accesskey="c">Page</a></li>
				<li id="ca-talk"><a href="https://wiki.archlinux.org/index.php/Talk:Bcache" title="Discussion about the content page [alt-shift-t]" accesskey="t">Discussion</a></li>
				<li id="ca-viewsource"><a href="https://wiki.archlinux.org/index.php?title=Bcache&amp;action=edit" title="This page is protected.
You can view its source [alt-shift-e]" accesskey="e">View source</a></li>
				<li id="ca-history"><a href="https://wiki.archlinux.org/index.php?title=Bcache&amp;action=history" rel="archives" title="Past revisions of this page [alt-shift-h]" accesskey="h">History</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-personal" role="navigation">
		<h3>Personal tools</h3>
		<div class="pBody">
			<ul>
				<li id="pt-createaccount"><a href="https://wiki.archlinux.org/index.php?title=Special:UserLogin&amp;returnto=Bcache&amp;type=signup">Create account</a></li>
				<li id="pt-login"><a href="https://wiki.archlinux.org/index.php?title=Special:UserLogin&amp;returnto=Bcache" title="You are encouraged to log in; however, it is not mandatory [alt-shift-o]" accesskey="o">Log in</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-logo" role="banner">
<a href="https://wiki.archlinux.org/index.php/Main_page" style="background-image: url(/skins/archlinux/archlogo.png);" title="Visit the main page"></a>
	</div>
	<div class="generated-sidebar portlet" id="p-navigation" role="navigation">
		<h3>Navigation</h3>
		<div class="pBody">
			<ul>
				<li id="n-mainpage-description"><a href="https://wiki.archlinux.org/index.php/Main_page" title="Visit the main page [alt-shift-z]" accesskey="z">Main page</a></li>
				<li id="n-categories"><a href="https://wiki.archlinux.org/index.php/Table_of_contents">Categories</a></li>
				<li id="n-portal"><a href="https://wiki.archlinux.org/index.php/Getting_involved" title="Various ways Archers can contribute to the community">Getting involved</a></li>
				<li id="n-currentevents"><a href="https://wiki.archlinux.org/index.php/ArchWiki:News" title="The latest lowdown on the wiki">Wiki news</a></li>
				<li id="n-randompage"><a href="https://wiki.archlinux.org/index.php/Special:Random" title="Load a random page [alt-shift-x]" accesskey="x">Random page</a></li>
			</ul>
		</div>
	</div>
	<div id="p-search" class="portlet" role="search">
		<h3><label for="searchInput">Search</label></h3>
		<div id="searchBody" class="pBody">
			<form action="/index.php" id="searchform">
				<input name="title" value="Special:Search" type="hidden">
				<input autocomplete="off" name="search" placeholder="Search" title="Search ArchWiki [alt-shift-f]" accesskey="f" id="searchInput" type="search">
				<input name="go" value="Go" title="Go to a page with this exact name if exists" id="searchGoButton" class="searchButton" type="submit">&nbsp;
				<input name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton" type="submit">
			</form>
		</div>
	</div>
	<div class="generated-sidebar portlet" id="p-interaction" role="navigation">
		<h3>interaction</h3>
		<div class="pBody">
			<ul>
				<li id="n-help"><a href="https://wiki.archlinux.org/index.php/Category:Help" title="Wiki navigation, reading, and editing help">Help</a></li>
				<li id="n-Contributing"><a href="https://wiki.archlinux.org/index.php/ArchWiki:Contributing">Contributing</a></li>
				<li id="n-recentchanges"><a href="https://wiki.archlinux.org/index.php/Special:RecentChanges" title="A list of recent changes in the wiki [alt-shift-r]" accesskey="r">Recent changes</a></li>
				<li id="n-Recent-talks"><a href="https://wiki.archlinux.org/index.php/Special:RecentChanges?namespace=0&amp;invert=1" rel="nofollow">Recent talks</a></li>
				<li id="n-newpages"><a href="https://wiki.archlinux.org/index.php/Special:NewPages">New pages</a></li>
				<li id="n-Reports"><a href="https://wiki.archlinux.org/index.php/ArchWiki:Reports">Reports</a></li>
				<li id="n-Requests"><a href="https://wiki.archlinux.org/index.php/ArchWiki:Requests">Requests</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-tb" role="navigation">
		<h3>Tools</h3>
		<div class="pBody">
			<ul>
				<li id="t-whatlinkshere"><a href="https://wiki.archlinux.org/index.php/Special:WhatLinksHere/Bcache" title="A list of all wiki pages that link here [alt-shift-j]" accesskey="j">What links here</a></li>
				<li id="t-recentchangeslinked"><a href="https://wiki.archlinux.org/index.php/Special:RecentChangesLinked/Bcache" title="Recent changes in pages linked from this page [alt-shift-k]" accesskey="k">Related changes</a></li>
				<li id="t-specialpages"><a href="https://wiki.archlinux.org/index.php/Special:SpecialPages" title="A list of all special pages [alt-shift-q]" accesskey="q">Special pages</a></li>
				<li id="t-print"><a href="https://wiki.archlinux.org/index.php?title=Bcache&amp;printable=yes" rel="alternate" title="Printable version of this page [alt-shift-p]" accesskey="p">Printable version</a></li>
				<li id="t-permalink"><a href="https://wiki.archlinux.org/index.php?title=Bcache&amp;oldid=337808" title="Permanent link to this revision of the page">Permanent link</a></li>
				<li id="t-info"><a href="https://wiki.archlinux.org/index.php?title=Bcache&amp;action=info">Page information</a></li>
			</ul>
		</div>
	</div>
</div><!-- end of the left (by default at least) column -->
<div class="visualClear"></div>
<div id="footer" role="contentinfo">
	<ul id="f-list">
		<li id="lastmod"> This page was last modified on 28 September 2014, at 03:02.</li>
		<li id="copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
		<li id="privacy"><a href="https://wiki.archlinux.org/index.php/ArchWiki:Privacy_policy" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="about"><a href="https://wiki.archlinux.org/index.php/ArchWiki:About" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="disclaimer"><a href="https://wiki.archlinux.org/index.php/ArchWiki:General_disclaimer" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
</div>
</div>
<script>/*<![CDATA[*/window.jQuery && jQuery.ready();/*]]>*/</script><script>if(window.mw){
mw.loader.state({"site":"loading","user":"ready","user.groups":"ready"});
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.action.view.postEdit","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest"],null,true);
}</script>
<script>if(window.mw){
mw.loader.state({"site":"ready"});
}</script>
<!-- Served in 0.016 secs. -->
<div class="suggestions" style="display: none; font-size: 11.4667px;"><div class="suggestions-results"></div><div class="suggestions-special"></div></div></body><!-- Cached/compressed 20140928030256 --></html>