#!/bin/zsh

USER=
CHOWN=
while true;
do
  case "$1" in
    -- ) break;;
    -b ) shift; BACKUP=t;;
    -u ) shift; USER=$1; shift;;
    -c ) shift; CHOWN=$1; shift;;
    *) break;;
  esac
done

indir=$1
outdir=$2

if [[ ! -d $indir ]]; then 
	echo "$indir does not exists!"
	exit 1
fi

PRE=""
[[ -n $USER ]] && PRE="sudo -u $USER "

cd $indir
if [[ -n $BACKUP ]]; then
	${=PRE} find . -type f -exec mv "$outdir/{}" "$outdir/{}.orig" \;
fi
${=PRE} cp -a --no-preserve=owner {*,.*}(N) $outdir
if [[ -n $CHOWN ]]; then
	${=PRE} find . -exec chown $CHOWN "$outdir/{}" \;
fi
