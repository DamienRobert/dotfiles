#!/bin/zsh

QUALITY=25 #smaller is better
AUDIOQUALITY=6 #smaller is better
AUDIOCOPY=false
MOVIE=false
EXT="avi"
VIDEOOPT=(-c:v libx264 -preset veryslow -tune film -threads 0 -vf hqdn3d)

while true;
do
  case "$1" in
    -- ) break ;;
    -q ) shift; QUALITY="$1"; shift  ;;
    -aq ) shift; AUDIOQUALITY="$1"; shift  ;;
    -acopy ) shift; AUDIOCOPY="true";  ;;
    -movie ) shift; MOVIE="true"; AUDIOQUALITY=3; EXT="mkv" ;;
    #activate vorbis rather than lame, higher is better here for
    #AUDIOQUALITY
    *) break;;
  esac
done

extract() {
  OUTPUT="$1.x264-working.$EXT"
  FINAL="$1.x264.$EXT"
  if [ ! -e "$FINAL" ]; then
    if [ "x$AUDIOCOPY" = "xtrue" ]; then
      allnice ffmpeg -i "$@" \
        $VIDEOOPT \
        -crf "$QUALITY" "$OUTPUT"
    elif [ "x$MOVIE" = "xtrue" ]; then
      allnice ffmpeg -i "$@" \
        $VIDEOOPT \
        -c:a libvorbis -compression_level 2 -q:a $AUDIOQUALITY \
        -crf "$QUALITY" "$OUTPUT"
      #Rem: pour le dvd->mkv, -scodec copy pour copier les sous-titres, -sn
      #pour les enlever, -s 380x288 pour réduire la taille
      #rem: pour libvorbis, higher=better, le défaut est 3
    else
      allnice ffmpeg -i "$@" \
        $VIDEOOPT \
        -c:a libmp3lame -compression_level 2 -q:a $AUDIOQUALITY \
        -crf "$QUALITY" "$OUTPUT"
    fi
    [ "$?" = "0" ] && mv "$OUTPUT" "$FINAL"
  fi
}

for i in "$@"; do
  extract "$i"
done
