#!/bin/zsh

ALL=
while true;
do
  case "$1" in
    -- ) break ;;
    -a|--all ) shift; ALL=t ;;
    *) break;;
  esac
done

COMMAND="[$1]"
FORMAT='[%track%	]<b>[%title%|%file%]</b>	[<i>%album%</i>][ (%disc%)]'
[[ -n $ALL ]] && FORMAT+='[ -A:%albumartist%][ -C:%composer%][ -P:%performer%]'
STATUS=$(mpc -f $FORMAT "$@")

if [[ -z $ICON && -x $HOME/mine/script/mpd/mpd_album_art.py ]]; then
  file=$($HOME/mine/script/mpd/mpd_album_art.py 2>/dev/null)
  #echo $file
  [[ -e $file ]] && ICON=$file
fi

[[ -z $ICON ]] && ICON="multimedia-player"

fixamp() {
	echo "$@" | sed -e 's/&/&amp;/g'
}

#notify-send n'affiche rien s'il y a un & dans le message!!
LIGNE1=$(echo $STATUS | sed -n '1p')
LIGNE2=$(echo $STATUS | sed -n '2p')
LIGNE3=$(echo $STATUS | sed -n '3p')
[[ -z $1 ]] && COMMAND=$(echo $LIGNE2 | cut -d ' ' -f 1)
POSITION=$(echo $LIGNE2 | cut -d ' ' -f 2)
TIME=$(echo $LIGNE2 | cut -d ' ' -f 5)
VOLUME=$(echo $LIGNE3 | cut -d ' ' -f 2)

AUTHOR=$(mpc -f '%artist%'|head -n 1)
[[ -z $AUTHOR ]] && AUTHOR=$(mpc -f '%name%'|head -n 1)
[[ -z $AUTHOR ]] && AUTHOR="mpc"
notify-send -t 5000 -u low -i $ICON "$AUTHOR" "$(fixamp "$LIGNE1\n$COMMAND $TIME	$POSITION (Vol:$VOLUME)")"
