#!/bin/zsh

MOUNT=
SDDIR=/dev/sdb2
RUNDIR=/run/media/dams/usbkey
MYDIR="$HOME/media/usbkey"

#On Numenor, I have trouble automounting the usb key
[[ $MYHOSTNAME == Numenor && ! -d ~/media/usbkey ]] && MOUNT="udisk"

#options: MOUNT=sudo or MOUNT=udisk
while true;
do
	case "$1" in
		-- ) break ;;
		-m ) shift; MOUNT=$1; shift ;;
		*) break;;
	esac
done

case $MOUNT in
	sudo)
		echo "Mounting $SDDIR (sudo)"
		sudo mkdir -p $RUNDIR
		sudo mount $SDDIR $RUNDIR
		;;
	udisk)
		echo "Mounting $SDDIR (udisk)"
		udisksctl mount -b $SDDIR -o 'noexec,nosuid,noatime'
		;;
esac

if [[ -d $MYDIR ]]; then
	echo "git push $MYDIR/dams/backups/gitbackup :"
	cd ~/backups/gitbackup
	git push "$MYDIR/dams/backups/gitbackup" :
	cd
	echo "unison.rb usb"
	unison.rb usb
else
	echo "$MYDIR is not available"
fi

case $MOUNT in
	sudo)
		echo "Unmounting $SDDIR"
		sudo umount $RUNDIR
		sudo rmdir $RUNDIR
		;;
	udisk)
		echo "Unmounting $SDDIR"
		umount $RUNDIR
		;;
esac
