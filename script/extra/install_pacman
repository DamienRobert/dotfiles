cd ~/opt/src
VERSION=4.1.2
wget ftp://ftp.archlinux.org/other/pacman/pacman-$VERSION.tar.gz
unarchive pacman-$VERSION.tar.gz

LIBARCHIVEVERSION=3.1.2
wget http://www.libarchive.org/downloads/libarchive-$LIBARCHIVEVERSION.tar.gz
unarchive libarchive-$LIBARCHIVEVERSION.tar.gz

cd libarchive-$LIBARCHIVEVERSION
./configure --prefix=$HOME/opt/packages/libarchive-$LIBARCHIVEVERSION
make && make install
cd ~/opt/packages
ln -snf libarchive-$LIBARCHIVEVERSION libarchive
cd ~/opt/bin
ln -s ../packages/libarchive/bin/* .
#cd ~/opt/include
#ln -s ../packages/libarchive/include/archive* .
#cd ~/opt/lib
#ln -s ../packages/libarchive/lib/ libarchive

cd ~/opt/src/pacman-$VERSION
PKG_CONFIG_PATH="$HOME/opt/packages/libarchive/lib/pkgconfig:" ./configure --prefix=$HOME/opt/packages/pacman-$VERSION --with-root-dir=$HOME/opt/arch
#--disable-internal-download
make CPATH=$HOME/opt/packages/libarchive/include && make install
cd ~/opt/packages
ln -snf pacman-$VERSION pacman
cd ~/opt/bin
ln -s ../packages/pacman/bin/{makepkg,pacman} .

#For alpm database
cd ~/opt/packages/pacman
mkdir -p var/{cache/pacman,lib/pacman,log/pacman}

#### Note ####

There is one problem when compiling/installing to a custom directory in a
PKGBUILD.

PREFIX=$HOME/opt/arch
ex:
  PREFIX=$HOME/opt/arch
  build() {
    cd ${pkgname}-${pkgver}
    ./configure --prefix=$PREFIX/usr --sysconfdir=$PREFIX/etc --libexecdir=$PREFIX/usr/lib --with-stroke-library
    make
  }
  package() {
    cd ${pkgname}-${pkgver}
    make DESTDIR="${pkgdir}" install
  }
make will install the files in $pkgdir/$PREFIX/usr

So in .pacman.conf, if
  RootDir     = /home/imb/damienrobert/opt/arch
installing the packages we will have files in 
  /home/imb/damienrobert/opt/arch/$PREFIX/usr
so I need to specify
  RootDir = /
but then mypacman -U fails at chdir('/') (I don't know why it needs it)
