#!/bin/zsh
# vim: ft=zsh
MYFILES=${MYFILES-"$HOME/mine/config"}
MYFILESNAME=${MYFILES#$HOME/}
export MYFILES MYFILESNAME

name=$1
[ -z $name ] && exit 1

NEWHOSTNAME=$2
NEWHOSTTYPE=$3

#. $MYFILES/00COMPUTERS
#info_computer $name
eval $($MYFILES/00COMPUTERS.rb --export $name)

targetssh=$SSHUNISON
target=ssh://$targetssh

echo "Init new computer $name with host $NEWHOSTNAME and type $NEWHOSTTYPE"
cat <<EOF
*** Eventuellement pour installer une clÃ© ssh: ***
#scp $HOME/.ssh/authorized_keys $targetssh:.ssh/
ssh-copy-id -i ~/.ssh/id_rsa.pub $targetssh
*************************************************
EOF
ssh2 $targetssh $(./01createdirs -init)
#################

myunisonsync -t $UNISONINIT $name
#ssh2 $targetssh '$HOME'/sync/common/progs/linkutils/mv_and_ln.pl '$HOME'/sync/common/$MYFILESNAME/ '$HOME'/sync/common/bin '$HOME'/sync/common/progs '$HOME'

if [ -n "$NEWHOSTNAME" -o -n "$NEWHOSTTYPE" ]; then
cat <<EOF | ssh2 $targetssh '>' $MYFILESNAME/hosttype.local 
MYHOSTNAME=$NEWHOSTNAME
MYHOSTTYPE=$NEWHOSTTYPE
EOF
fi

ssh2 $targetssh '$HOME'/$MYFILESNAME/new/00updatecompte
