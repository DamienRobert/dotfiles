#!/bin/sh

. "$DOTFILES/.initvars"
do_link() {
	orig="$1"
	dest="$2"
	borig=`basename "$orig"`
	[ "x$borig" = "x." -o "x$borig" = "x.." -o "x$borig" = "x*" -o "x$borig" = "x.*" ] && return 1
	[ -z "$dest" ] && dest="$borig"
	#echo "orig: $orig, dest: $dest"
	if [ ! -e "$orig" ]; then return 1; fi
	if [ -e "$dest" -a ! -h "$dest" ]; then
		echo "Warning: mv $dest $dest.old"
		mv "$dest" "$dest.old";
	fi
	if [ -h "$dest" ]; then
		destlink=`readlink "$dest"`
		if [ "$orig" != "$destlink" ]; then
			echo "$dest -> $orig" 
			ln -snf "$orig" "$dest"
		fi
	else
		echo "$dest -> $orig" 
		ln -s "$orig" "$dest"
	fi
}

cd "$HOME"
echo "# dotfiles"
for i in "$DOTFILES"/{*,.*}; do
	if [ "x`basename \"$i\"`" != "x.config" ]; then
		do_link "$i"
	fi
done

echo "# dotfiles/.config"
mkdir -p -m 700 "$HOME/.config"
cd "$HOME/.config"
for i in "../$DOTFILES"/.config/{*,.*}; do
	do_link "$i"
done

echo "# symlinks"
cd "$HOME"
do_link mine/config
mkdir -p tmp/
cd "$HOME/.ssh"
do_link authorized_keys.default authorized_keys

[ -e "$HOME/.ssh/authorized_keys" ] || echo "!! ~/.ssh/authorized keys does not exist!"
